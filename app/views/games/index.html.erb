<h1>Listing games</h1>

<%= link_to "View picks", picks_path%>

<table>
  <tr>
    <td><%= link_to "<- Prev Day", games_path(:day => (@day+1)) %></td>
    <td>
    <% if @day == 0 %>
      Today
    <% elsif @day > 0 %>
      Games <%= pluralize(@day.abs, "day") %> ago
    <% else %>
      Games in <%= pluralize(@day.abs, "day") %>
    <% end %>
    </td>
    <td><%= link_to "Next Day ->", games_path(:day => (@day-1)) %></td>
  </tr>
</table>

<table>
  <thead>
    <tr>
      <th>Game time</th>
      <th colspan="4"></th>
      <th>Pick</th>
    </tr>
  </thead>

  <tbody>
    <% @games.each do |game| %>
      <tr class="game-row">
        <td><%= game.game_time %></td>
        <td>
          <% if game.picks.find_by(user_id: current_user.id) %>
            <button class="pick-team-link" disabled data-teamid=<%= game.away_team.id %> data-gameid=<%= game.id %>>
              <%= game.away_team.name %>
            </button>
          <% else %>
            <button class="pick-team-link" data-teamid=<%= game.away_team.id %> data-gameid=<%= game.id %>>
              <%= game.away_team.name %>
            </button>
          <% end %>
        </td>
        <td> @ <td>
        <td>
          <% if game.picks.find_by(user_id: current_user.id) %>
            <button class="pick-team-link" disabled data-teamid=<%= game.home_team.id %> data-gameid=<%= game.id %>>
              <%= game.home_team.name %>
            </button>
          <% else %>
            <button class="pick-team-link" data-teamid=<%= game.home_team.id %> data-gameid=<%= game.id %>>
              <%= game.home_team.name %>
            </button>
          <% end %>
        </td>
        <% if game.picks.find_by(user_id: current_user.id) %>
          <td class="message">You picked the team <%= game.picks.find_by(user_id: current_user.id).team.name %>!</td>
        <% else %>
            <td class="message"></td>
        <% end %>
      </tr>
    <% end %>
  </tbody>
</table>

<br>

<%= link_to 'New Game', new_game_path %>

<script>
  var token = "<%= form_authenticity_token %>";
  $(".pick-team-link").on("click", function() {
    if ($(this).attr("disabled") == "disabled") {
      return;
    }
    var row = $(this).parents(".game-row");
    console.log("clicked");
    var game_id = $(this).data("gameid");
    var team_id = $(this).data("teamid");
    $.post( 
      "/picks", 
      { 
        team_id: team_id,
        game_id: game_id,
        authenticity_token: "<%= form_authenticity_token %>"
      }, function( data ) {
        row.find("td.message").text(data.message)
        row.find("button.pick-team-link").attr('disabled','disabled');
      }, "json");
  });
</script>
